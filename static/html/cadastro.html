<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro - EmoConnect</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/auth.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body class="auth-page">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1>🌟 EmoConnect</h1>
          <p>Comece sua jornada de autocuidado</p>
        </div>

        <!-- Formulário de Cadastro -->
        <form id="cadastro-form" class="auth-form">
          <h2>Criar Conta</h2>

          <div class="form-group">
            <label for="nome">
              <i class="fas fa-user"></i> Nome Completo
            </label>
            <input
              type="text"
              id="nome"
              name="nome"
              placeholder="Seu nome"
              required
              autocomplete="name"
              minlength="3"
            />
          </div>

          <div class="form-group">
            <label for="email"> <i class="fas fa-envelope"></i> Email </label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="seu@email.com"
              required
              autocomplete="email"
            />
            <small id="email-feedback" class="form-feedback"></small>
          </div>

          <div class="form-group">
            <label for="senha"> <i class="fas fa-lock"></i> Senha </label>
            <div class="password-input">
              <input
                type="password"
                id="senha"
                name="senha"
                placeholder="Mínimo 6 caracteres"
                required
                autocomplete="new-password"
                minlength="6"
              />
              <button
                type="button"
                class="toggle-password"
                id="toggle-password"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div id="password-strength" class="password-strength">
              <div class="strength-bar">
                <div class="strength-bar-fill" id="strength-bar-fill"></div>
              </div>
              <small id="strength-text">Digite uma senha</small>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmar-senha">
              <i class="fas fa-lock"></i> Confirmar Senha
            </label>
            <div class="password-input">
              <input
                type="password"
                id="confirmar-senha"
                name="confirmar-senha"
                placeholder="Digite a senha novamente"
                required
                autocomplete="new-password"
                minlength="6"
              />
              <button
                type="button"
                class="toggle-password"
                id="toggle-password-confirm"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <small id="confirm-feedback" class="form-feedback"></small>
          </div>

          <div class="form-group">
            <label> <i class="fas fa-smile"></i> Escolha seu Avatar </label>
            <div class="avatar-selector">
              <button
                type="button"
                class="avatar-option selected"
                data-avatar="😊"
              >
                😊
              </button>
              <button type="button" class="avatar-option" data-avatar="😎">
                😎
              </button>
              <button type="button" class="avatar-option" data-avatar="🥰">
                🥰
              </button>
              <button type="button" class="avatar-option" data-avatar="🌟">
                🌟
              </button>
              <button type="button" class="avatar-option" data-avatar="🦋">
                🦋
              </button>
              <button type="button" class="avatar-option" data-avatar="🌈">
                🌈
              </button>
              <button type="button" class="avatar-option" data-avatar="💜">
                💜
              </button>
              <button type="button" class="avatar-option" data-avatar="🌸">
                🌸
              </button>
            </div>
            <input type="hidden" id="avatar" name="avatar" value="😊" />
          </div>

          <div
            id="error-message"
            class="alert alert-error"
            style="display: none"
          ></div>

          <button
            type="submit"
            class="btn btn-primary btn-block"
            id="cadastro-btn"
          >
            <i class="fas fa-user-plus"></i> Criar Conta
          </button>

          <div class="auth-footer">
            <p>Já tem uma conta? <a href="login.html">Faça login</a></p>
          </div>
        </form>
      </div>

      <div class="auth-illustration">
        <div class="illustration-content">
          <i class="fas fa-heart illustration-icon"></i>
          <h3>Junte-se a nós!</h3>
          <p>Cuide da sua saúde mental de forma simples e eficaz.</p>

          <div class="benefits">
            <div class="benefit-item">
              <i class="fas fa-shield-alt"></i>
              <span>100% seguro e privado</span>
            </div>
            <div class="benefit-item">
              <i class="fas fa-robot"></i>
              <span>IA especializada em emoções</span>
            </div>
            <div class="benefit-item">
              <i class="fas fa-mobile-alt"></i>
              <span>Acesse de qualquer lugar</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        cadastrar,
        verificarEmail,
        redirectIfAuthenticated
      } from "../js/auth.js";

      // Redirecionar se já estiver logado
      redirectIfAuthenticated();

      let selectedAvatar = "😊";

      // Toggle mostrar/ocultar senha
      const setupPasswordToggle = (buttonId, inputId) => {
        const button = document.getElementById(buttonId);
        const input = document.getElementById(inputId);

        button.addEventListener("click", () => {
          const type = input.type === "password" ? "text" : "password";
          input.type = type;

          const icon = button.querySelector("i");
          icon.classList.toggle("fa-eye");
          icon.classList.toggle("fa-eye-slash");
        });
      };

      setupPasswordToggle("toggle-password", "senha");
      setupPasswordToggle("toggle-password-confirm", "confirmar-senha");

      // Seletor de avatar
      const avatarOptions = document.querySelectorAll(".avatar-option");
      const avatarInput = document.getElementById("avatar");

      avatarOptions.forEach((option) => {
        option.addEventListener("click", () => {
          avatarOptions.forEach((opt) => opt.classList.remove("selected"));
          option.classList.add("selected");
          selectedAvatar = option.dataset.avatar;
          avatarInput.value = selectedAvatar;
        });
      });

      // Verificar força da senha
      const senhaInput = document.getElementById("senha");
      const strengthBar = document.getElementById("strength-bar-fill");
      const strengthText = document.getElementById("strength-text");

      senhaInput.addEventListener("input", () => {
        const senha = senhaInput.value;
        const strength = calculatePasswordStrength(senha);

        strengthBar.style.width = `${strength.percent}%`;
        strengthBar.className = `strength-bar-fill strength-${strength.level}`;
        strengthText.textContent = strength.text;
      });

      function calculatePasswordStrength(senha) {
        if (senha.length === 0) {
          return { percent: 0, level: "weak", text: "Digite uma senha" };
        }
        if (senha.length < 6) {
          return { percent: 25, level: "weak", text: "Muito fraca" };
        }

        let score = 0;
        if (senha.length >= 8) score += 25;
        if (senha.length >= 10) score += 25;
        if (/[a-z]/.test(senha) && /[A-Z]/.test(senha)) score += 25;
        if (/\d/.test(senha)) score += 15;
        if (/[^a-zA-Z0-9]/.test(senha)) score += 10;

        if (score < 40) return { percent: 40, level: "weak", text: "Fraca" };
        if (score < 60) return { percent: 60, level: "medium", text: "Média" };
        if (score < 80) return { percent: 80, level: "strong", text: "Forte" };
        return { percent: 100, level: "strong", text: "Muito forte" };
      }

      // Verificar email em tempo real
      const emailInput = document.getElementById("email");
      const emailFeedback = document.getElementById("email-feedback");
      let emailCheckTimeout;

      emailInput.addEventListener("input", () => {
        clearTimeout(emailCheckTimeout);

        const email = emailInput.value.trim();
        if (!email || !email.includes("@")) {
          emailFeedback.textContent = "";
          emailFeedback.className = "form-feedback";
          return;
        }

        emailCheckTimeout = setTimeout(async () => {
          const exists = await verificarEmail(email);
          if (exists) {
            emailFeedback.textContent = "⚠️ Este email já está cadastrado";
            emailFeedback.className = "form-feedback error";
          } else {
            emailFeedback.textContent = "✓ Email disponível";
            emailFeedback.className = "form-feedback success";
          }
        }, 500);
      });

      // Verificar se senhas coincidem
      const confirmarSenhaInput = document.getElementById("confirmar-senha");
      const confirmFeedback = document.getElementById("confirm-feedback");

      confirmarSenhaInput.addEventListener("input", () => {
        const senha = senhaInput.value;
        const confirmar = confirmarSenhaInput.value;

        if (confirmar.length === 0) {
          confirmFeedback.textContent = "";
          confirmFeedback.className = "form-feedback";
        } else if (senha === confirmar) {
          confirmFeedback.textContent = "✓ Senhas coincidem";
          confirmFeedback.className = "form-feedback success";
        } else {
          confirmFeedback.textContent = "⚠️ Senhas não coincidem";
          confirmFeedback.className = "form-feedback error";
        }
      });

      // Formulário de cadastro
      const cadastroForm = document.getElementById("cadastro-form");
      const errorMessage = document.getElementById("error-message");
      const cadastroBtn = document.getElementById("cadastro-btn");

      cadastroForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nome = document.getElementById("nome").value.trim();
        const email = emailInput.value.trim();
        const senha = senhaInput.value;
        const confirmarSenha = confirmarSenhaInput.value;

        // Limpar erro anterior
        errorMessage.style.display = "none";
        errorMessage.textContent = "";

        // Validações
        if (!nome || !email || !senha || !confirmarSenha) {
          showError("Por favor, preencha todos os campos");
          return;
        }

        if (nome.length < 3) {
          showError("Nome deve ter no mínimo 3 caracteres");
          return;
        }

        if (senha.length < 6) {
          showError("Senha deve ter no mínimo 6 caracteres");
          return;
        }

        if (senha !== confirmarSenha) {
          showError("As senhas não coincidem");
          return;
        }

        // Desabilitar botão durante requisição
        cadastroBtn.disabled = true;
        cadastroBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Criando conta...';

        try {
          await cadastrar(nome, email, senha, selectedAvatar);

          // Redirecionar para página inicial
          window.location.href = "/html/index.html";
        } catch (error) {
          showError(error.message || "Erro ao criar conta. Tente novamente.");
        } finally {
          cadastroBtn.disabled = false;
          cadastroBtn.innerHTML =
            '<i class="fas fa-user-plus"></i> Criar Conta';
        }
      });

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = "block";

        // Scroll para o erro
        errorMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    </script>
  </body>
</html>
